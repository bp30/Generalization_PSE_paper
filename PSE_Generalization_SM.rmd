---
title: "PSE generalization effect - supplementary materials"
author: "Ding-Cheng (Bruce) Peng"
email: "b.peng@auckland.ac.nz"
date: "July 2021"
output: html_document
---
# Session Setup
```{r}
library(checkpoint)
checkpoint(
  snapshotDate = "2020-10-01"
  , R.version = "3.6.2" # replaced with your version of R
  , checkpointLocation = "." # replaced with your own directory
)

rm(list = ls()); gc()
```


# Package and directory set up
```{r setup, include = FALSE}
# Load packages
if (!require(pacman)) install.packages('pacman')
pacman::p_load(tidyverse, brms, bayestestR) 

# source custom codes
source("C:/Users/dpen466/Google Drive/Phd (1)/Experiment/Studies/Data/IPE/source/Statistics_helper_function(LMM and Bayesian)/Bayes_scripts.R")
source("C:/Users/dpen466/Google Drive/Phd (1)/Experiment/Studies/Data/IPE/source/Statistics_helper_function(LMM and Bayesian)/LMM_scripts.R")

# ggplot colours
palette <- c("#eeaa7b", "#00b159", "#00aedb", "#F8766D", "#9590FF", "#CC9933", "#0000FF")
```

# Data setup

```{r}
# Loading data
IPEG.df <- read.csv('IPEG_fulldata_N=30.csv', header = T)

# Remove deleted trials from data frame
IPEG.df <- IPEG.df[complete.cases(IPEG.df$Condition), ]

# Convert Story_ID and Condition vectors into factors and ensure Identify condition is set as the reference group
IPEG.df$Story_ID <- as.factor(IPEG.df$Story_ID)
IPEG.df$Conditions <- as.factor(IPEG.df$Conditions)
levels(IPEG.df$Conditions) <- c('Identify', 'Imagine')

# Data transformations 
## Generate the five factor variable for Match conditions
IPEG.df$Match_condition<- IPEG.df$Match + 1
IPEG.df$Match_condition[IPEG.df$Conditions == "Identify"] <- 1
IPEG.df$Match_condition <- as.factor(IPEG.df$Match_condition)
levels(IPEG.df$Match_condition) <- c("Identify", "S-A-", "S-A+","S+A-", "S+A+")

# Data transformations 
IPEG.df <- IPEG.df %>% 
              mutate(
                # Effect code sex and age of helping targets(Female = 1, male = -1; 1 = Old, -1 = Young)
                HT_sex_c = ifelse(HT_sex == 'F', 1, -1),
                HT_age_c = ifelse(HT_age == 'Old', 1, -1),
                # Create a dummy variable = for the condition and match variables
                dummy_img = as.numeric (Conditions == 'Imagine'),
                dummy_SAMM = as.numeric(Match_condition == "S-A-"),
                dummy_SMMAM = as.numeric(Match_condition == "S-A+"),
                dummy_SMAMM = as.numeric(Match_condition == "S+A-"),
                dummy_SAM = as.numeric(Match_condition == "S+A+"))
```



# Experiment 1: Bayesian cumulative link mixed model
## Model 1
```{r}
# Model:
model1_exp1 <- brm(data = IPEG.df, family = cumulative("logit"),
                   bf(Help ~ Conditions + HT_sex_c + HT_age_c + (Conditions|participant) + (Conditions|Story_ID) + (Conditions|HTFace_ID) +
                        (Conditions|STFace_ID)) +
                   lf(disc ~ 0 + Conditions, cmc = F),
                      prior = c(prior(normal (0,1), class = b),
                                prior(normal(0,1.2), class = Intercept),
                                prior(exponential(1), class = sd),
                                prior(lkj(1), class = cor)),
                  iter = 7000,warmup = 2000, chains = 8, cores = 8, 
                  seed = 67, sample_prior = T,save_all_pars = T, control = list(adapt_delta = 0.99))

saveRDS(model1_exp1, file = 'model1_exp1.rds')

# model1_exp1 <- readRDS("model1_exp1.rds")
# Diagnostic Checks: pp check and traceplots
pp_check(model1_exp1)
plot(model1_exp1)
# Prior predictive simulation 
prior_sim(model1_exp1, c("sd_participant", 'cor_participant', "b"))
# Rhat and sample sizes
bayes_samples(model1_exp1)

# Summary
summary(model1_exp1, prob = 0.89)
# pd
p_direction(model1_exp1, parameters = "b_Conditions")
# % in ROPE
rope(model1_exp1, ci = 1, range = c(-0.18, 0.18), parameters = "b_Conditions")

# Extract posterior samples 
set.seed(67); posterior_m1_exp1 <- posterior_samples(model1_exp1) 
# OR
OR_m1_exp1 <- exp(posterior_m1_exp1$b_Conditions)
posterior_summary(OR_m1_exp1, probs = c(0.055, 0.945))
# Latent SD of conditions
latent_SD(posterior_m1_exp1)
```
### Plot: Figure XX
```{r}
# Plot the predicted probability of each category on the outcome measure for each condition
PSE_plot_exp1 <- conditional_effects(model1_exp1, categorical = T)
plot(PSE_plot_exp1)[[1]] +
  scale_x_discrete(labels = c("Control", "Imagine Helping")) +
  theme_classic() +
  xlab("Experimental Condition") +
  ylim (0, 0.45)
```

## Model 2
```{r}
# Model:
model2_exp1 <- brm(data = IPEG.df, family = cumulative("logit"),
                   bf(Help~Match_condition + HT_sex_c + HT_age_c + (Match_condition|participant) + (Match_condition|Story_ID) +
                      (Match_condition|HTFace_ID) + (Match_condition|STFace_ID)) +
                   lf(disc ~ 0 + Match_condition, cmc = F),
                      prior = c(prior(normal(0,1), class = b),
                                prior(normal(0,1.2), class = Intercept),
                                prior(exponential(1), class = sd),
                                prior(lkj(1), class = cor)),
                   iter = 7000, warmup = 2000, chains = 8, cores = 8, seed = 67, sample_prior = T, save_all_pars = T)


saveRDS(model2_exp1, file = 'model2_exp1.rds')

# model2_exp1 <- readRDS("model2_exp1.rds")
# Diagnostic Checks: pp check and traceplots
pp_check(model2_exp1)
plot(model2_exp1)
# Prior predictive simulation 
prior_sim(model2_exp1, c("sd_participant", 'cor_participant', "b"))
# Rhat and sample sizes
bayes_samples(model2_exp1)

# Summary
summary(model2_exp1, prob = 0.89)
# pd
p_direction(model2_exp1, parameters = "b_Match_condition")

# Extract posterior samples 
set.seed(67); posterior_m2_exp1 <- posterior_samples(model2_exp1) 
# Latent SD of conditions
latent_SD(posterior_m2_exp1)
```
### Plots: Figure XX......
```{r}
# Violin plot (Figure XX)
gen_effect_exp1 <- cbind.data.frame("S-A-" = posterior_m2_exp1$b_Match_conditionSMAM,
                               "S-A+" = posterior_m2_exp1$b_Match_conditionSMAP, 
                               "S+A-" = posterior_m2_exp1$b_Match_conditionSPAM, 
                               "S+A+" = posterior_m2_exp1$b_Match_conditionSPAP)
gen_effect_exp1.df <- gen_effect_exp1
gen_effect_exp1 <- gen_effect_exp1 %>% gather("S-A-", "S-A+", "S+A-", "S+A+", key = Condition, value = Posterior)
violin_gen1 <- violin_bayes(gen_effect_exp1, HDI_range = c(0.055, 0.945))[[1]]
violin_gen1 + 
  labs(x = "Condition Contrast", y = "Logit") +
  scale_x_discrete(labels = c("S-A-" = "S-A- > Control", 
                              "S-A+" = "S-A+ > Control", 
                              "S+A-" = "S+A- > Control", 
                              "S+A+" = "S+A+ > Control"))
  
# Summaries
violin_bayes(gen_effect_exp1, HDI_range = c(0.055, 0.945))[[2]]
#pd
p_direction (gen_effect_exp1.df)
# OR
posterior_summary(exp(gen_effect_exp1.df), probs = c(0.055, 0.945))
# % in ROPE
rope(gen_effect_exp1.df, ci = 1, range = c(-0.18, 0.18))
#---------------------------------------------------------------------------------------------------------------------------------------------
# Contrasts between the four imagine helping match conditions
cond_contrasts_exp1 <- cbind.data.frame ("S-A-<S-A+" = gen_effect_exp1.df$`S-A+` - gen_effect_exp1.df$`S-A-`, 
                                    "S-A-<S+A-" = gen_effect_exp1.df$`S+A-` - gen_effect_exp1.df$`S-A-`,
                                    "S-A-<S+A+" = gen_effect_exp1.df$`S+A+` - gen_effect_exp1.df$`S-A-`,
                                    "S-A+<S+A-" = gen_effect_exp1.df$`S+A-` - gen_effect_exp1.df$`S-A+`,
                                    "S-A+<S+A+" = gen_effect_exp1.df$`S+A+` - gen_effect_exp1.df$`S-A+`,
                                    "S+A-<S+A+" = gen_effect_exp1.df$`S+A+` - gen_effect_exp1.df$`S+A-`)
colnames(cond_contrasts_exp1) <- c("S-A-<S-A+", "S-A-<S+A-","S-A-<S+A+", "S-A+<S+A-", "S-A+<S+A+", "S+A-<S+A+")
cond_contrasts_exp1.df<- cond_contrasts_exp1
cond_contrasts_exp1 <- cond_contrasts_exp1 %>% gather("S-A-<S-A+", "S-A-<S+A-","S-A-<S+A+", "S-A+<S+A-", "S-A+<S+A+", "S+A-<S+A+", 
                                                      key = Condition, value = Posterior)
contrast_plot1 <- violin_bayes(cond_contrasts_exp1, HDI_range = c(0.055, 0.945))[[1]]
contrast_plot1 + 
  labs(x = "Condition Contrast", y = "Logit")

# Summaries
violin_bayes(cond_contrasts_exp1, HDI_range=c(0.055, 0.945))[[2]]
# pd and direction
p_direction (cond_contrasts_exp1.df)
# % in ROPE
rope(cond_contrasts_exp1.df, ci = 1, range = c(-0.18, 0.18))
# ORs
posterior_summary(exp(cond_contrasts_exp1.df), probs = c(0.055, 0.945))
#----------------------------------------------------------------------------------------------------------------------------------------------
# Plot the predicted probability of each category on the outcome measure for each condition (Figure XX)
Gen_plot_exp1 <- conditional_effects(model2_exp1, categorical = T)
plot(Gen_plot_exp1)[[1]] +
  scale_x_discrete(labels = c("Control", "S-A-", "S-A+", "S+A-", "S+A+")) +
  theme_classic() +
  xlab("Conditions") +
  ylim (0, 0.45)
```



## Order restricted model comparisons
* Models to be compared
** 1) a null model (M0): all conditions (including control) are equal
** 2) Unrestricted model (Mu1): Control != S-A- != S+A- != S-A+ != S+A+
** 3) Unrestricted model (Mu2): Control != S-A- = S+A- = S-A+ = S+A+
** 5) Theory-driven model (M1): Control < S-A- < S+A- ~= S-A+ < S+A+
** 6) Data-driven model (M2): Control < [S-A- = S+A- = S-A+ = S+A+]

### Model set up
```{r}
# M0 model:
m0_exp1 <- brm(data = IPEG.df, family = cumulative("logit"), 
                  Help ~ HT_sex_c + HT_age_c + (1|participant) + (1|Story_ID) + (1|HTFace_ID) + (1|STFace_ID),
                  prior = c(prior(normal(0,1), class = b),
                            prior(normal(0,1.2), class = Intercept),
                            prior(exponential(1), class = sd)), 
                  iter = 7000, warmup = 2000, chains = 8, cores = 8, seed = 67, sample_prior = T, save_all_pars = T)
saveRDS(m0_exp1, file = 'm0_exp1.rds')

# m0_exp1 <- readRDS("m0_exp1.rds")

# Mu1 model: 
mu1_exp1 <- brm(data = IPEG.df, family = cumulative("logit"),
                   Help ~ Match_condition + HT_sex_c + HT_age_c + (1|participant) + (1|Story_ID) + (1|HTFace_ID) + (1|STFace_ID),
                   prior = c(prior(normal (0, 1), class = b),
                             prior(normal(0, 1.2), class = Intercept),
                             prior(exponential(1), class = sd)),
                   iter = 7000, warmup = 2000, chains = 8, cores = 8, seed = 67, sample_prior = T, save_all_pars = T)
saveRDS(mu1_exp1, file = 'mu1_exp1.rds')

# mu1_exp1 <- readRDS("mu1_exp1.rds")
## Extract posterior
set.seed(67); mu1_posterior_exp1 <- posterior_samples(mu1_exp1) 

# Mu2 model:
mu2_exp1 <- brm(data = IPEG.df, family = cumulative("logit"),
              Help ~ Conditions + HT_sex_c + HT_age_c + (1|participant) + (1|Story_ID) + (1|HTFace_ID) + (1|STFace_ID),
              prior = c(prior(normal (0, 1), class = b),
                        prior(normal(0, 1.2), class = Intercept),
                        prior(exponential(1), class = sd)),
                iter = 7000, warmup = 2000, chains = 8, cores = 8, seed = 67, sample_prior = T, 
                save_all_pars = T, control = list(adapt_delta = 0.99))
saveRDS(mu2_exp1, file = 'mu2_exp1.rds')

# mu2_exp1 <- readRDS("mu2_exp1.rds")
## Extract posterior
set.seed(67); mu2_posterior_exp1 <- posterior_samples(mu2_exp1)

# M1
m1_exp1 <- (mu1_posterior_exp1[, "b_Match_conditionSMAM"] > 0) &
           (mu1_posterior_exp1[, "b_Match_conditionSMAP"] - mu1_posterior_exp1[, "b_Match_conditionSMAM"] > 0) &
           (abs(mu1_posterior_exp1[, "b_Match_conditionSMAP"] - mu1_posterior_exp1[, "b_Match_conditionSPAM"]) <= 0.18) |
           (mu1_posterior_exp1[, "b_Match_conditionSMAP"] > mu1_posterior_exp1[, "b_Match_conditionSPAM"]) |
           (mu1_posterior_exp1[, "b_Match_conditionSMAP"] < mu1_posterior_exp1[, "b_Match_conditionSPAM"]) & 
           (mu1_posterior_exp1[, "b_Match_conditionSPAP"] - mu1_posterior_exp1[, "b_Match_conditionSPAM"] > 0)

# M2
m2_exp1 <- (mu2_posterior_exp1[, "b_ConditionsImagine"] > 0) 
```
#### Bayes Factors
```{r}
# Mu1/M0
set.seed(67); (BF_Mu1vsM0_exp1 <- bayes_factor(mu1_exp1, m0_exp1))
# Mu2/M0
set.seed(67); (BF_Mu2vsM0_exp1 <- bayes_factor(mu2_exp1, m0_exp1))
# M1/Mu1
(BF_M1vsMu1_exp1 <- restricted_BF(m1_exp1, 4e4, 5, 2))
# M2/Mu2
(BF_M2vsMu2_exp1 <- restricted_BF(m2_exp1, 4e4, 2))
# By transitivity
BF_M1vsM0_exp1 <- BF_M1vsMu1_exp1 * BF_Mu1vsM0_exp1$bf
BF_M2vsM0_exp1 <- BF_M2vsMu2_exp1 * BF_Mu2vsM0_exp1$bf
BF_M2vsM1_exp1 <- BF_M2vsM0_exp1 / BF_M1vsM0_exp1
BF_M2vsMu1_exp1 <- BF_M2vsM0_exp1 / BF_Mu1vsM0_exp1$bf

# BFs
print(paste0("M2/M1: ", BF_M2vsM1_exp1))
print(paste0("M2/Mu: ", BF_M2vsMu1_exp1))
print(paste0("M2/M0: ", BF_M2vsM0_exp1))

print(paste0("M1/Mu: ", BF_M1vsMu1_exp1))
print(paste0("M1/M0: ", BF_M1vsM0_exp1))

print(paste0("Mu/M0: ", BF_Mu1vsM0_exp1$bf))
```




















